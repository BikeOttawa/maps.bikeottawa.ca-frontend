<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8' />
    <title>Ottawa Bike Amenities Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src="../js/tokens.js"></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js'></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.min.js"></script>
    <script src='../js/maps.js'></script>
    <script src='../js/osm-bundle.js'></script>
    <script src='../js/mapbox-button-control.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css' rel='stylesheet' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <link href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.4.2/mapbox-gl-geocoder.css" rel="stylesheet" type="text/css" />
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <link href='../css/maps.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        li {
            margin: 4px 0;
        }
        
        #app {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        .mapbox-gl-add_amenity {
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: auto;
            background-image: url("../img/add_place.svg");
        }
        
        .top-left {
            position: fixed;
            margin-top: 50px;
            margin-left: 10px;
            z-index: 10;
        }
        
        .centered {
            position: fixed;
            top: 30%;
            left: 30%;
            margin-top: -50px;
            margin-left: -100px;
            z-index: 10;
        }
        
        .width13 {
            width: 130px;
            float: left;
        }
        
        .dark .rounded-toggle input[type=radio]:checked+label,
        .dark .rounded-toggle .active {
            color: #333;
        }
        
        .edit-icon {
            background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='iso-8859-1'%3F%3E%3C!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0) --%3E%3Csvg version='1.1' id='Capa_1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' x='0px' y='0px' viewBox='0 0 490.273 490.273' style='enable-background:new 0 0 490.273 490.273;' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cg%3E%3Cpath d='M313.548,152.387l-230.8,230.9c-6.7,6.7-6.7,17.6,0,24.3c3.3,3.3,7.7,5,12.1,5s8.8-1.7,12.1-5l230.8-230.8 c6.7-6.7,6.7-17.6,0-24.3C331.148,145.687,320.248,145.687,313.548,152.387z'/%3E%3Cpath d='M431.148,191.887c4.4,0,8.8-1.7,12.1-5l25.2-25.2c29.1-29.1,29.1-76.4,0-105.4l-34.4-34.4 c-14.1-14.1-32.8-21.8-52.7-21.8c-19.9,0-38.6,7.8-52.7,21.8l-25.2,25.2c-6.7,6.7-6.7,17.6,0,24.3l115.6,115.6 C422.348,190.187,426.748,191.887,431.148,191.887z M352.948,45.987c7.6-7.6,17.7-11.8,28.5-11.8c10.7,0,20.9,4.2,28.5,11.8 l34.4,34.4c15.7,15.7,15.7,41.2,0,56.9l-13.2,13.2l-91.4-91.4L352.948,45.987z'/%3E%3Cpath d='M162.848,467.187l243.5-243.5c6.7-6.7,6.7-17.6,0-24.3s-17.6-6.7-24.3,0l-239.3,239.5l-105.6,14.2l14.2-105.6 l228.6-228.6c6.7-6.7,6.7-17.6,0-24.3c-6.7-6.7-17.6-6.7-24.3,0l-232.6,232.8c-2.7,2.7-4.4,6.1-4.9,9.8l-18,133.6 c-0.7,5.3,1.1,10.6,4.9,14.4c3.2,3.2,7.6,5,12.1,5c0.8,0,1.5-0.1,2.3-0.2l133.6-18 C156.748,471.587,160.248,469.887,162.848,467.187z'/%3E%3C/g%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3Cg%3E%3C/g%3E%3C/svg%3E%0A");
        }
        
        .marker {
            background-size: cover;
            width: 16px;
            height: 16px;
            /*border-radius: 50%;*/
            /*cursor: pointer;*/
        }
    </style>
</head>

<body>
    <div id='app' class='col12 contain clip'>
        <div id='newPlace' class='top-left fill-darken2 width28 round hidden'>
            <div class='pad1 dark inline'>
                <h3>Create New Place</h3>
            </div>
            <div class='fill-darken1 icon close button fr' onclick="document.getElementById('newPlace').classList.add('hidden');g_newPlaceMarker.remove()"></div>
            <div class='clearfix'></div>
            <div id='newPlaceButtons' class='pad1 dark'></div>
        </div>
        <div id='newPlaceParams' class='top-left fill-darken2 width28 round hidden'>
            <div id='newPlaceParamsTitle' class='pad1 dark inline'>
                <h3>Create New Place</h3>
            </div>
            <div class='fill-darken1 icon close button fr' onclick="document.getElementById('newPlaceParams').classList.add('hidden');g_newPlaceMarker.remove()"></div>
            <div class='clearfix'></div>
            <div id='newPlaceParamsContent' class='pad1 dark'></div>
            <div id='newPlaceParamsBtn' class='margin4 width8 fill-darken2 button space-bottom' onclick="newPlaceParamsSubmit()">Submit</div>
        </div>
        <div id='newPlaceParams' class='top-left fill-darken2 width28 round hidden'>
            <div id='newPlaceParamsTitle' class='pad1 dark inline'>
                <h3>Create New Place</h3>
            </div>
            <div class='fill-darken1 icon close button fr' onclick="document.getElementById('newPlaceParams').classList.add('hidden');g_newPlaceMarker.remove()"></div>
            <div class='clearfix'></div>
            <div id='newPlaceParamsContent' class='pad1 dark'></div>
            <div id='newPlaceParamsBtn' class='margin4 width8 fill-darken2 button space-bottom' onclick="newPlaceParamsSubmit()">Submit</div>
        </div>
        <div id='bikeParkingHint' class='centered fill-darken3 width36 round hidden'>
            <div id='bikeParkingHintTitle' class='pad1 dark inline'>
                <h3>Bicycle parking</h3>
            </div>
            <div class='fill-darken1 icon close button fr' onclick="document.getElementById('bikeParkingHint').classList.add('hidden');"></div>
            <div id='bikeParkingHintContent' class='pad1 dark'>
                <div class='small'>If there are multiple bike racks next to each other, map one rack on the map and assign combined capacity.</div>
                <div class='width16 pad0 center'><img src='../img/amenities/parking_bollard.jpg'>Bollard</div>
                <div class='width16 pad0 center'><img src='../img/amenities/parking_rack.jpg'>Rack</div>
                <div class='width16 pad0 center'><img src='../img/amenities/parking_loops.jpg'>Loops</div>
                <div class='width16 pad0 center'><img src='../img/amenities/parking_stands.jpg'>Stands</div>
            </div>
        </div>
        <div id='iconsAttrib' class='centered fill-darken3 width36 round hidden'>
            <div id='iconsAttribTitle' class='pad1 dark inline'>
                <h3>Icons</h3>
            </div>
            <div class='fill-darken1 icon close button fr' onclick="document.getElementById('iconsAttrib').classList.add('hidden');"></div>
            <div id='iconsAttribContent' class='pad1 dark'>

            </div>
        </div>
        <div class="loading" title="loading..." id="loader"></div>
        <div id='map'></div>
        <div id='success' class='note warning contain col6 margin4 hidden z100 pad4'>
            <h3>Success!</h3>
            <p>New place successfully created. It should appear on the map in the next few hours</p>
        </div>
        <div id='error' class='note error contain col6 margin4 hidden z100 pad4'>
            <h3>Error</h3>
            <p>Something went wrong. Failed to submit new place. Try again</p>
        </div>
        <div id='menu'>
            <input id='dark-v10' type='radio' name='rtoggle' value='dark'>
            <label for='dark-v10'>dark</label>
            <input id='light-v10' type='radio' name='rtoggle' value='light'>
            <label for='light-v10'>light</label>
            <input id='bright-v9' type='radio' name='rtoggle' value='bright' checked='checked'>
            <label for='bright-v9'>bright</label>
            <input id='satellite-streets-v11' type='radio' name='rtoggle' value='satellite'>
            <label for='satellite-streets-v11'>satellite</label>
        </div>
        <div id='legendbtn' class='fill-darken2 pad1 icon book button fr hidden' onclick="document.getElementById('legendbtn').classList.add('hidden');document.getElementById('legend').classList.remove('hidden')"></div>
        <div id='legend' class='fill-darken2 width36 round pin-topright mobile-cols col12'>
            <div id='closebtn' class='fill-darken2 pad1 icon close button fr' onclick="document.getElementById('legendbtn').classList.remove('hidden');document.getElementById('legend').classList.add('hidden')"></div>
            <div class='pad1 dark'>
                <h3>Bicycle Amenities</h3><br>
                <form>
                    <fieldset id='layers' class='checkbox-pill clearfix '>
                    </fieldset>
                </form>
                <!-- <div class='pad1 small hide-mobile'>
                    <p>This map is maintained by volunteers like you.</p>
                </div> -->
                <div class='pad1 small'>
                    <p>To add missing amenity use <img src="../img/add_place.svg"> icon in the bottom left corner. Works best on the spot on your smartphone!</p>
                    <p>Another way contribute is by taking pictures of amenities with <a target="_blank" href="https://www.mapillary.com/mobile-apps">Mapillary app</a>.</p>
                </div>
                <div class='pad1 small hide-mobile'>
                    <p>See more maps and apps on our <a href='https://maps.bikeottawa.ca' target='_blank'>Maps webpage</a>.</p>
                </div>
                <div class='center pad2 hide-mobile'>
                    <a href='https://bikeottawa.ca' target="_blank"><img src="../img/logos/bikeottawa.png" style="width:32px; height:32px;"></a>
                    <a href='https://github.com/BikeOttawa/maps.bikeottawa.ca-frontend' target="_blank"><img src="../img/logos/github.png" style="width:32px; height:32px;"></a>
                    <a href='https://twitter.com/BikeOttawa' target="_blank"><img src="../img/logos/twitter.png" style="width:32px; height:32px;"></a>
                </div>
                <a class='fr fill-darken3 pad1 rounded-toggle short icon button bike hide-mobile' onclick="document.getElementById('about').classList.remove('hidden');"></a>
                <div class=' pad1 small'>Last update: <span id='dateUpdated'>[...]</span></div>
                <div class='clearfix'></div>
                <div id='about' class='small hidden'>
                    <p>Developed and maintained by <a href="https://twitter.com/zzptichka">Yaro Shkvorets</a>
                        <br> Icons by <a href="https://www.flaticon.com/authors/freepik">Freepik</a>,
                        <a href="https://www.flaticon.com/authors/pixel-perfect">Pixel Perfect</a>,
                        <a href="https://www.flaticon.com/authors/smalllikeart">smalllikeart</a>,
                        <a href="https://www.flaticon.com/authors/smashicons">Smash Icons</a> from <a href="https://www.flaticon.com">www.flaticon.com</a></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const g_layers = [{
            id: "osm_bicycle_parking",
            names: 'Bike parking',
            name: 'Bike parking',
            enabled: false,
            image: 'bike-parking.png',
            key: 'amenity',
            val: 'bicycle_parking',
            showName: false,
            tags: ['amenity', 'description', 'bicycle_parking', 'capacity', 'covered', 'seasonal', 'fixme'],
            title: 'Bike parking',
            createTags: {
                amenity: 'bicycle_parking'
            },
            createOptTags: ['bicycle_parking', 'capacity', 'covered'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/parking_706409?term=bike%20parking&page=1&position=64'
        }, {
            id: "osm_bicycle_shop",
            names: 'Bike Shops',
            name: 'Bike Shop',
            enabled: false,
            image: 'bike-shop.png',
            key: 'shop',
            val: 'bicycle',
            showName: true,
            tags: ['name', 'service:bicycle:repair', 'service:bicycle:pump', 'description', 'phone', 'website', 'fixme'],
            title: 'Bike shop',
            createTags: {
                shop: 'bicycle'
            },
            createOptTags: ['name', 'description'],
            showGoogle: true,
            iconAttrName: 'Smashicons',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/bike-shop_1818885?term=bike%20shop&page=1&position=5'
        }, {
            id: "osm_bicycle_repair_stations",
            names: 'Repair Stations',
            name: 'Repair Station',
            enabled: false,
            image: 'bike-repair.png',
            key: 'amenity',
            val: 'bicycle_repair_station',
            showName: false,
            tags: ['amenity', 'service:bicycle:pump', 'service:bicycle:chain_tool', 'fixme'],
            title: 'Bike repair station',
            createTags: {
                amenity: 'bicycle_repair_station'
            },
            createOptTags: ['service:bicycle:pump', 'service:bicycle:chain_tool', 'description'],
            showGoogle: true,
            iconAttrName: 'Pixel Perfect',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/air-pump_782565?term=pump&page=3&position=5'
        }, {
            id: "osm_air_compressors",
            names: 'Compressed Air',
            name: 'Compressed Air',
            enabled: false,
            image: 'bike-compressor.png',
            key: 'amenity',
            val: 'compressed_air',
            showName: false,
            tags: ['amenity', 'description', 'fee', 'fixme'],
            title: 'Compressed air',
            createTags: {
                amenity: 'compressed_air'
            },
            createOptTags: ['fee'],
            showGoogle: true,
            iconAttrName: 'smalllikeart',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/air-compressor_1254066?term=air%20compressor&page=1&position=55'
        }, {
            id: "osm_drinking_water",
            names: 'Drinking Water',
            name: 'Drinking Water',
            enabled: false,
            image: 'bike-fountain.png',
            key: 'amenity',
            val: 'drinking_water',
            showName: false,
            tags: ['amenity', 'indoor', 'seasonal', 'bottle', 'description', 'fixme'],
            title: 'Drinking fountain',
            createTags: {
                amenity: 'drinking_water'
            },
            createOptTags: ['bottle', 'indoor'],
            showGoogle: true,
            iconAttrName: 'Smashicons',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/water_1973278'
        }, {
            id: "osm_toilets",
            names: 'Toilets',
            name: 'Toilet',
            enabled: false,
            image: 'bike-toilet.png',
            key: 'amenity',
            val: 'toilets',
            showName: false,
            tags: ['amenity', 'indoor', 'seasonal', 'fee', 'description', 'fixme'],
            title: 'Toilet',
            createTags: {
                amenity: 'toilets'
            },
            createOptTags: ['fee', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/toilet_2203644?term=toilets&page=1&position=42'
        }, {
            id: "osm_shelters",
            names: 'Shelters',
            name: 'Shelter',
            enabled: false,
            image: 'bike-shelter.png',
            key: 'amenity',
            val: 'shelter',
            showName: false,
            tags: ['amenity', 'description', 'fixme'],
            title: 'Shelter',
            createTags: {
                amenity: 'shelter'
            },
            createOptTags: ['description'],
            showGoogle: true,
            iconAttrName: 'Pixel Perfect',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/tent_637086?term=tent&page=1&position=75'
        }, {
            id: "osm_phone",
            names: 'Payphones',
            name: 'Payphone',
            enabled: false,
            image: 'bike-telephone.png',
            key: 'amenity',
            val: 'telephone',
            showName: false,
            tags: ['description', 'fixme'],
            title: 'Payphone',
            createTags: {
                amenity: 'telephone'
            },
            createOptTags: ['description'],
            showGoogle: true,
            iconAttrName: 'Those Icons',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/call_523081?term=phone%20receiver&page=1&position=5'
        }, {
            id: "osm_picnic_tables",
            names: 'Picnic Tables',
            name: 'Picnic Table',
            enabled: false,
            image: 'bike-picnic.png',
            key: 'leisure',
            val: 'picnic_table',
            showName: false,
            tags: ['amenity', 'covered', 'description', 'fixme'],
            title: 'Picnic table',
            createTags: {
                leisure: 'picnic_table'
            },
            createOptTags: ['covered'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/picnic-table_1784697?term=picnic%20table&page=1&position=41'
        }, {
            id: "osm_bench",
            names: 'Benches',
            name: 'Bench',
            enabled: false,
            image: 'bike-bench.png',
            key: 'amenity',
            val: 'bench',
            showName: false,
            tags: ['amenity', 'backrest', 'material', 'fixme'],
            title: 'Bench',
            createTags: {
                amenity: 'bench'
            },
            createOptTags: ['backrest', 'material'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/bench_2054945?term=bench&page=1&position=53'
        }, {
            id: "osm_bbq",
            names: 'Outdoor Grills',
            name: 'Outdoor Grill',
            enabled: false,
            image: 'bike-bbq.png',
            key: 'amenity',
            val: 'bbq',
            showName: false,
            tags: ['amenity', 'covered', 'fuel', 'description', 'fixme'],
            title: 'Outdoor grill',
            createTags: {
                amenity: 'bbq'
            },
            createOptTags: ['fuel'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/barbecue_2759887?term=bbq&page=1&position=35'
        }, {
            id: "osm_pubs",
            names: 'Pubs',
            name: 'Pub',
            enabled: false,
            image: 'bike-pub.png',
            key: 'amenity',
            val: 'pub',
            showName: true,
            tags: ['amenity', 'name', 'outdoor_seating', 'description', 'phone', 'website', 'fixme'],
            title: 'Pub',
            createTags: {
                amenity: 'pub'
            },
            createOptTags: ['name', 'outdoor_seating', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/beer_931949?term=pub&page=1&position=2'
        }, {
            id: "osm_brewery",
            names: 'Craft Breweries',
            name: 'Craft Brewery',
            enabled: false,
            image: 'bike-brew.png',
            key: 'craft',
            val: 'brewery',
            showName: true,
            tags: ['name', 'outdoor_seating', 'description', 'phone', 'website', 'fixme'],
            title: 'Craft Brewery',
            createTags: {
                craft: 'brewery'
            },
            createOptTags: ['name', 'outdoor_seating', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/hop_2190103?term=hops&page=1&position=13'
        }, {
            id: "osm_restaurants",
            names: 'Restaurants',
            name: 'Restaurant',
            enabled: false,
            image: 'bike-restaurant.png',
            key: 'amenity',
            val: 'restaurant',
            showName: true,
            tags: ['amenity', 'name', 'cuisine', 'takeaway', 'outdoor_seating', 'description', 'phone', 'website', 'fixme'],
            title: 'Restaurant',
            createTags: {
                amenity: 'restaurant'
            },
            createOptTags: ['name', 'cuisine', 'outdoor_seating', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/fork_1046857?term=restaurant&page=1&position=4'
        }, {
            id: "osm_fastfood",
            names: 'Fast Food',
            name: 'Fast Food Place',
            enabled: false,
            image: 'bike-fastfood.png',
            key: 'amenity',
            val: 'fast_food',
            showName: true,
            tags: ['amenity', 'name', 'cuisine', 'outdoor_seating', 'description', 'phone', 'website', 'fixme'],
            title: 'Fast food place',
            createTags: {
                amenity: 'fast_food'
            },
            createOptTags: ['name', 'cuisine', 'outdoor_seating', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/burger_878052?term=burger&page=1&position=2'
        }, {
            id: "osm_cafes",
            names: 'Cafes',
            name: 'Cafe',
            enabled: false,
            image: 'bike-cafe.png',
            key: 'amenity',
            val: 'cafe',
            showName: true,
            tags: ['amenity', 'name', 'cuisine', 'outdoor_seating', 'description', 'phone', 'website', 'fixme'],
            title: 'Cafe',
            createTags: {
                amenity: 'cafe'
            },
            createOptTags: ['name', 'outdoor_seating', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/cafe_1786930?term=cafe&page=1&position=25'
        }, {
            id: "osm_icecream",
            names: 'Ice Cream',
            name: 'Ice Cream Place',
            enabled: false,
            image: 'bike-icecream.png',
            key: 'amenity',
            val: 'ice_cream',
            showName: true,
            tags: ['amenity', 'name', 'outdoor_seating', 'description', 'phone', 'website', 'fixme'],
            title: 'Ice cream shop',
            createTags: {
                amenity: 'ice_cream'
            },
            createOptTags: ['name', 'outdoor_seating', 'description'],
            showGoogle: true,
            iconAttrName: 'Good Ware',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/ice-cream_692705?term=icecream&page=1&position=14'
        }, {
            id: "osm_splashpad",
            names: 'Splash Pads',
            name: 'Splash Pad',
            enabled: false,
            image: 'bike-splashpad.png',
            key: 'playground',
            val: 'splash_pad',
            showName: true,
            tags: ['name', 'description', 'fixme'],
            title: 'Splash pad',
            createTags: {
                leisure: 'playground',
                playground: 'splash_pad'
            },
            createOptTags: ['description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/fountain_618971?term=fountain&page=1&position=28'
        }, {
            id: "osm_info",
            names: 'Information',
            name: 'Information',
            enabled: false,
            image: 'bike-map.png',
            key: 'tourism',
            val: 'information',
            showName: true,
            tags: ['name', 'information', 'description', 'fixme'],
            title: 'Information',
            createTags: {
                tourism: 'information'
            },
            createOptTags: ['name', 'information', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/map_854878'
        }, {
            id: "osm_viewpoint",
            names: 'Viewpoints',
            name: 'Viewpoint',
            enabled: false,
            image: 'bike-viewpoint.png',
            key: 'tourism',
            val: 'viewpoint',
            showName: true,
            tags: ['name', 'description', 'fixme'],
            title: 'Viewpoint',
            createTags: {
                tourism: 'viewpoint'
            },
            createOptTags: ['name', 'description'],
            showGoogle: true,
            iconAttrName: 'Freepik',
            iconAttrUrl: 'https://www.flaticon.com/free-icon/binoculars_410664?term=binoculars&page=1&position=19'
        }, ];

        let MapCursor = ''
        mapboxgl.accessToken = mapbox_token;
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/' + document.querySelector('input[name="rtoggle"]:checked').id,
            center: [-75.697927, 45.417431],
            zoom: 13,
            minZoom: 10,
            maxZoom: 20,
            maxBounds: [
                [-76.385193, 44.963826],
                [-75.011902, 45.614998]
            ],
            attributionControl: false
        });

        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
        map.addControl(new mapboxgl.AttributionControl({
            compact: true
        }), 'bottom-right');
        const geocoder = new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            mapboxgl: mapboxgl,
            bbox: [-76.385193, 44.963826, -75.011902, 45.614998],
            zoom: 13,
            limit: 10,
            asyncGeocoder: nominatimGeocoder,
            collapsed: true,
            marker: true
        })
        map.addControl(geocoder, 'bottom-left')
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true
        }), 'bottom-left');

        addStyleSwitcher();

        function addPlace(event) {

            g_newPlaceMarker.remove()
            document.getElementById("newPlace").classList.add('hidden')
            document.getElementById("newPlaceParams").classList.add('hidden')

            if (MapCursor == 'crosshair') {
                MapCursor = ''
            } else {
                MapCursor = 'crosshair'
                if (/Mobi/.test(navigator.userAgent)) { //for mobiles - hide legend
                    document.getElementById('legendbtn').classList.remove('hidden');
                    document.getElementById('legend').classList.add('hidden');
                }
            }
        }

        const ctrlAdd = new MapboxGLButtonControl({
            className: "mapbox-gl-add_amenity",
            title: "Add Amenity",
            eventHandler: addPlace
        });
        map.addControl(ctrlAdd, 'bottom-left')

        //helpers & handlers below

        function addStyleSwitcher() {
            var layerList = document.getElementById('menu');
            var inputs = layerList.getElementsByTagName('input');

            for (var i = 0; i < inputs.length; i++) {
                inputs[i].onclick = switchLayer;
            }
        }

        function switchLayer(layer) {
            const layerId = layer.target.id;
            map.setStyle('mapbox://styles/mapbox/' + layerId);

        }

        function initFromFile() {
            map.addSource('bike_amenities', {
                type: 'geojson',
                data: 'http://localhost:8080/amenities/bike_amenities.geojson',
            });

            g_layers.forEach(layer => {
                map.loadImage('../img/amenities/' + layer.image, function(error, image) {
                    if (error) throw error;
                    map.addImage('image_' + layer.id, image);
                    map.addLayer({
                        "id": layer.id,
                        "type": "symbol",
                        "source": 'bike_amenities',
                        "filter": ['==', layer.key, layer.val],
                        "layout": {
                            'visibility': document.getElementById(layer.id).checked ? 'visible' : 'none',
                            'icon-image': ["match", ['get', layer.key], layer.val, 'image_' + layer.id, ''],
                            'icon-size': 0.5,
                            "icon-allow-overlap": true,
                            "text-allow-overlap": true,
                            'text-field': layer.showName ? ['get', 'name'] : '',
                            //'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 0.6],
                            "text-size": {
                                "stops": [
                                    [0, 0],
                                    [15, 0],
                                    [15.1, 10]
                                ]
                            },
                            'text-anchor': 'top'
                        }
                    });
                });

            });
        }

        function init() {

            map.addSource('bike_amenities', {
                type: 'vector',
                url: 'mapbox://' + mapbox_username + '.amenities?fresh=true',
            });
            g_layers.forEach(layer => {
                map.loadImage('../img/amenities/' + layer.image, function(error, image) {
                    if (error) throw error;
                    map.addImage('image_' + layer.id, image);
                    map.addLayer({
                        "id": layer.id,
                        "type": "symbol",
                        "source": 'bike_amenities',
                        "source-layer": 'layer',
                        "filter": ['==', layer.key, layer.val],
                        "layout": {
                            'visibility': document.getElementById(layer.id).checked ? 'visible' : 'none',
                            'icon-image': ["match", ['get', layer.key], layer.val, 'image_' + layer.id, ''],
                            'icon-size': 0.5,
                            "icon-allow-overlap": true,
                            "text-allow-overlap": true,
                            'text-field': layer.showName ? ['get', 'name'] : '',
                            //'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
                            'text-offset': [0, 0.6],
                            "text-size": {
                                "stops": [
                                    [0, 0],
                                    [15, 0],
                                    [15.1, 10]
                                ]
                            },
                            'text-anchor': 'top'
                        }
                    });
                });
            });
        }

        map.on('style.load', function() {
            if (window.location.hostname.indexOf('localhost') != -1) {
                initFromFile()
            } else {
                init()
            }
        });

        const form = document.getElementById("layers");
        const url = parseUrl(window.location.search.substr(1).split('&'));
        const enabled = url['layers'] ? url['layers'].split(';') : [];

        g_layers.forEach(l => {
            const input = document.createElement("input");
            input.setAttribute('type', 'checkbox')
            input.setAttribute('id', l.id)
            if (l.enabled || enabled.includes(l.id)) {
                input.setAttribute('checked', 'checked')
            }
            input.onclick = toggleFilter
            form.appendChild(input);
            const label = document.createElement('label')
            label.setAttribute('for', l.id)
            label.setAttribute('class', 'unround short button icon check quiet width16 text-left')
            label.setAttribute('id', l.id + '-label')
            label.innerHTML = '<img src="../img/amenities/' + l.image + '" style="width:16px">&nbsp;&nbsp;' + l.names;

            form.appendChild(label);
        })


        const buttons = document.getElementById("newPlaceButtons");
        g_layers.forEach(l => {
            const input = document.createElement("input");
            input.setAttribute('type', 'checkbox')
            input.setAttribute('id', 'new_' + l.id)
            input.setAttribute('class', 'hidden')
            input.onclick = chooseNewPlace
            buttons.appendChild(input);
            const label = document.createElement('label')
            label.setAttribute('for', 'new_' + l.id)
            label.setAttribute('class', 'unround short button check quiet width13')
            label.setAttribute('style', 'text-align:left;')
            label.innerHTML = '<img src="../img/amenities/' + l.image + '" style="width:16px">&nbsp;&nbsp;' + l.name;
            buttons.appendChild(label);
        })
        const bottom = document.createElement("div");
        bottom.setAttribute('class', 'clearfix')
        buttons.appendChild(bottom);

        function toggleFilter(event) {
            map.setLayoutProperty(event.target.id, 'visibility', document.getElementById(event.target.id).checked ? 'visible' : 'none')
            buildUrl()
        }

        let g_newPlaceType = ''
        let g_newPlaceMarker = new mapboxgl.Marker()

        function chooseNewPlace(event) {
            document.getElementById("newPlace").classList.add('hidden')
            document.getElementById("newPlaceParams").classList.remove('hidden')
            g_newPlaceType = event.target.id.replace('new_', '')

            const place = g_layers.find(function(x) {
                return x.id === g_newPlaceType
            })
            document.getElementById("newPlaceParamsTitle").innerHTML = '<h3>' + '<img src="../img/amenities/' + place.image + '" style="width:16px">&nbsp;&nbsp;New ' + place.name + '</h3>'
            const content = document.getElementById("newPlaceParamsContent");
            content.innerHTML = ''
            place.createOptTags.forEach(tag => {
                const tagDef = g_TagsDefinitions.find(function(x) {
                    return x.tag === tag
                })
                const label = document.createElement("label");
                label.setAttribute('for', tag)
                label.setAttribute('class', 'clearfix')
                    //label.setAttribute('id',tag)
                label.innerHTML = tagDef.name;
                if (tag == 'bicycle_parking') {
                    label.innerHTML += "<div class='fill-darken1 button space-left1' style='width:20px;height:20px;padding:0' onclick=document.getElementById('bikeParkingHint').classList.remove('hidden');>?</div>"
                }
                content.appendChild(label);

                if (tagDef.options[0] == 'editable' || tagDef.options[0] == 'text' || tagDef.options[0] == 'edit') {
                    const input = document.createElement("input");
                    input.setAttribute('type', 'text')
                    input.setAttribute('class', 'col12')
                    input.setAttribute('id', tag + '_text')
                    content.appendChild(input);
                } else {
                    const div = document.createElement("div");
                    div.setAttribute('class', 'rounded-toggle inline')
                        //div.setAttribute('style','')
                    content.appendChild(div)

                    for (let t of tagDef.options) {
                        const option = document.createElement("input");
                        if (t == '') {
                            continue;
                        }
                        option.type = 'radio'
                        option.name = tag
                        option.id = tag + t
                        option.value = t
                        div.appendChild(option);
                        const label = document.createElement("label");
                        //label.setAttribute('class','fill-lighten2')
                        label.setAttribute('for', tag + t)
                        label.innerHTML = t
                        div.appendChild(label)
                    }
                }
            })
            const bottom = document.createElement("div");
            bottom.setAttribute('class', 'clearfix')
            content.appendChild(bottom);

        }

        function buildUrl(id = '') {
            let layers = '';
            for (let layer of g_layers) {
                layers += document.getElementById(layer.id).checked ? layer.id + ';' : '';
            }
            window.history.replaceState(null, null, window.location.pathname +
                '?&lat=' + map.getCenter().lat +
                '&lng=' + map.getCenter().lng +
                '&zoom=' + map.getZoom() +
                (layers == '' ? '' : ('&layers=' + layers)) +
                (id == '' ? '' : ('&id=' + id)));

        }

        function newPlaceParamsSubmit() {
            document.getElementById("newPlaceParams").classList.add('hidden')
            document.getElementById('success').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            const amenity = g_layers.find(function(x) {
                return x.id === g_newPlaceType
            })
            const createTags = {};
            createTags[amenity.key] = amenity.val
            for (let tag of amenity.createOptTags) {
                const tagDef = g_TagsDefinitions.find(function(x) {
                    return x.tag === tag
                })
                if (tagDef.options[0] == 'editable' || tagDef.options[0] == 'text' || tagDef.options[0] == 'edit') {
                    const text = document.getElementById(tag + '_text')
                    if (text.value != '') {
                        createTags[tag] = text.value
                    }
                    continue;
                }
                for (let val of tagDef.options) {
                    if (val != '' && document.getElementById(tag + val).checked) {
                        createTags[tag] = val
                        break
                    }
                }
            }


            createOsmNode(g_newPlaceMarker.getLngLat().lat, g_newPlaceMarker.getLngLat().lng, createTags, 'Created amenity based on mapillary and local knowledge - https://maps.bikeottawa.ca/amenities')
                .then(function() {
                    document.getElementById('success').classList.remove('hidden');

                    var el = document.createElement('div');
                    el.className = 'marker'
                    const place = g_layers.find(function(x) {
                        return x.id === g_newPlaceType
                    })

                    el.setAttribute('style', 'background-image: url("../img/amenities/' + place.image + '");');
                    new mapboxgl.Marker(el)
                        .setLngLat(g_newPlaceMarker.getLngLat())
                        .setPopup(new mapboxgl.Popup({
                                offset: 25
                            }) // add popups
                            .setHTML('<h4>New ' + place.name + '</h4><p>Newly added place. It should appear on the map in the next few hours</p>'))
                        .addTo(map);

                    g_newPlaceMarker.remove();
                })
                .catch(function() {
                    document.getElementById('error').classList.remove('hidden');
                    document.getElementById("newPlaceParams").classList.remove('hidden')
                })
        }

        map.on('moveend', function(e) {
            document.getElementById('success').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');
            buildUrl();
        });

        map.on('click', function(e) {

            document.getElementById('success').classList.add('hidden');
            document.getElementById('error').classList.add('hidden');

            if (MapCursor == 'crosshair') { //handle click to add new place
                MapCursor = ''
                document.getElementById("newPlace").classList.remove('hidden');
                g_newPlaceMarker = new mapboxgl.Marker({
                        draggable: true
                    })
                    .setLngLat(e.lngLat)
                    .addTo(map);
                return;
            }

            const features = map.queryRenderedFeatures(e.point, {
                layers: g_layers.map(l => l.id)
            });
            if (!features.length) {
                return;
            }
            const feature = features[0];
            const layer = g_layers.filter(obj => {
                return obj.id === feature.layer.id
            })[0];
            if (layer && layer.tags && layer.title) {
                displayOsmElementInfo(feature.properties.id, e.lngLat, layer.tags, 'Bicycle amenities based on mapillary and local knowledge - https://maps.bikeottawa.ca/amenities', layer.title, layer.showGoogle);
            } else {
                displayOsmElementInfo(feature.properties.id, e.lngLat, ['name', 'description', 'fixme'], 'Bicycle amenities based on mapillary and local knowledge - https://maps.bikeottawa.ca/amenities', '', true);
            }

            buildUrl(feature.properties.id);
            //window.history.replaceState(null, null, window.location.pathname+'?&lat='+e.lngLat.lat+'&lng='+e.lngLat.lng+'&zoom='+map.getZoom()+'&id='+feature.properties.id+'&layers='+getCheckedLayers());
        });

        map.on('mousemove', function(e) {
            const features = map.queryRenderedFeatures(e.point, {
                layers: g_layers.map(l => l.id)
            });
            map.getCanvas().style.cursor = (features.length) ? 'pointer' : MapCursor;
        });

        map.on('load', function(e) {
            addUpdatedDate(mapbox_username + '.amenities')
            document.getElementById("loader").style.visibility = "hidden";
            const url = parseUrl(window.location.search.substr(1).split('&'));
            const lat = url['lat']
            const lng = url['lng']
            let z = url['zoom']
            if (lat && lng) {
                if (!z) {
                    z = 18;
                }
                map.flyTo({
                    center: [lng, lat],
                    zoom: z
                })
                map.once('moveend', function() {
                    map.fire("click", {
                        point: map.project([lng, lat]),
                        lngLat: {
                            lng: lng,
                            lat: lat
                        }
                    });
                });
            }
        });
    </script>
</body>

</html>
