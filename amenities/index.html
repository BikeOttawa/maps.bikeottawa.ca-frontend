<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Ottawa Bike Amenities Map</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.js'></script>
    <script  data-cfasync="false" src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.6.1/mapbox-gl.css' rel='stylesheet' />
    <link href='https://www.mapbox.com/base/latest/base.css' rel='stylesheet' />
    <link rel='stylesheet' href='../css/mapbox-gl-geocoder.css' type='text/css' />
    <link href='../css/maps.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        li { margin: 4px 0; }
        #app { position:absolute; top:0; right:0; bottom:0; left:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>
<div id='app' class='col12 contain clip'>
<div id='map'></div>
<div id='menu'>
  <input id='dark-v10' type='radio' name='rtoggle' value='dark'>
  <label for='dark-v10'>dark</label>
  <input id='light-v10' type='radio' name='rtoggle' value='light' checked='checked'>
  <label for='light-v10'>light</label>
  <input id='bright-v9' type='radio' name='rtoggle' value='bright'>
  <label for='bright-v9'>bright</label>
  <input id='satellite-streets-v11' type='radio' name='rtoggle' value='satellite'>
  <label for='satellite-streets-v11'>satellite</label>
</div>
<div id='legendbtn' class='fill-darken2 pad1 icon book button fr' onclick="$('#legendbtn').toggle();$('#legend').toggle()"></div>
<div id='legend' class='fill-darken2 col4 round pin-topright hidden'>
  <div id='closebtn' class='fill-darken2 pad1 icon close button fr' onclick="$('#legendbtn').toggle();$('#legend').toggle()"></div>
  <div class='clearfix'></div>
  <div class='pad1 dark'>
    <h3>Bicycle Amenities</h3><br>
    <form>
    <fieldset id='layers' class='checkbox-pill clearfix '>
    </fieldset>
    </form>
    <div class='pad1 small'>
      <p>This crowdsourced map shows amenities that could be useful for people on bikes.</p>
      <p>The map is maintained by Bike Ottawa volunteers like you. <p>
      <p>Help us add more stuff on the map and contribute to what's already on it!</p>
      <p>See more maps and apps on our <a href='https://maps.bikeottawa.ca' target='_blank'>Maps webpage</a>. <p>
    </div>
    <div class='center pad2'>
    	<a href='https://bikeottawa.ca' target="_blank"><img src="../img/logos/bikeottawa.png" style="width:32px; height:32px;"></a>
      <a href='https://github.com/BikeOttawa/maps.bikeottawa.ca-frontend' target="_blank"><img src="../img/logos/github.png" style="width:32px; height:32px;"></a>
      <a href='https://twitter.com/BikeOttawa' target="_blank"><img src="../img/logos/twitter.png" style="width:32px; height:32px;"></a>
    </div>
    <a class='fr fill-darken3 pad1 rounded-toggle short icon button bike' onclick="$('#about').toggle()"></a>
    <div class='fr pad1 small'>Last update: <span id='dateUpdated'>[...]</span></div>
    <div class='clearfix'></div>
    <div id='about' class='center small hidden'>
        Made possible with City of Ottawa Open Data and the help of OpenStreetMap Canada and Bike Ottawa volunteers.
    </div>
  </div>
</div>
<div class="loading" title="loading..." id="loader"></div>
</div>

<script src='../js/maps.js'></script>
<script src='../js/osm-bundle.js'></script>
<script src='../js/mapbox-gl-geocoder.min.js'></script>
<script>
const layers = [
    {id:"osm_bicycle_parking", name:'Bike parking', enabled: false, image:'bike-parking.png', key:'amenity', val:'bicycle_parking', showName:false, tags: ['amenity','description','bicycle_parking','capacity','covered','fixme'], title:'Bike parking'},
    {id:"osm_bicycle_repair_stations", name:'Repair Stations', enabled: false, image:'bike-repair.png', key:'amenity', val:'bicycle_repair_station', showName:false, tags: ['amenity','service:bicycle:pump','service:bicycle:chain_tool','fixme'], title:'Bike repair station'},
    {id:"osm_bicycle_shop", name:'Bike Shops', enabled: false, image:'bike-shop.png', key:'shop', val:'bicycle', showName:true, tags: ['name','service:bicycle:repair','service:bicycle:pump','description','phone','website','fixme'], title:'Bike shop'},
    {id:"osm_pubs", name:'Pubs', enabled: false, image:'bike-pub.png', key:'amenity', val:'pub', showName:true, tags: ['amenity','name','outdoor_seating','description','phone','website','fixme'], title:'Pub'},
    {id:"osm_restaurants", name:'Restaurants', enabled: false, image:'bike-restaurant.png', key:'amenity', val:'restaurant', showName:true, tags: ['amenity','name','cuisine','takeaway','outdoor_seating','description','phone','website','fixme'], title:'Restaurant'},
    {id:"osm_fastfood", name:'Fast Food', enabled: false, image:'bike-fastfood.png', key:'amenity', val:'fast_food', showName:true, tags: ['amenity','name','cuisine','outdoor_seating','description','phone','website','fixme'], title:'Fast food place'},
    {id:"osm_cafes", name:'Cafes', enabled: false, image:'bike-cafe.png', key:'amenity', val:'cafe', showName:true, tags: ['amenity','name','cuisine','outdoor_seating','description','phone','website','fixme'], title:'Cafe'},
    {id:"osm_icecream", name:'Ice Cream', enabled: false, image:'bike-icecream.png', key:'amenity', val:'ice_cream', showName:true, tags: ['amenity','name','outdoor_seating','description','phone','website','fixme'], title:'Ice cream shop'},
    {id:"osm_drinking_water", name:'Drinking Water', enabled: false, image:'bike-fountain.png', key:'amenity', val:'drinking_water', showName:false, tags: ['amenity','indoor','seasonal','bottle','description','fixme'], title:'Drinking fountain'},
    {id:"osm_toilets", name:'Toilets', enabled: false, image:'bike-toilet.png', key:'amenity', val:'toilets', showName:false, tags: ['amenity','indoor','seasonal','fee','description','fixme'], title:'Toilets'},
    {id:"osm_shelters", name:'Shelters', enabled: false, image:'bike-shelter.png', key:'amenity', val:'shelter', showName:false, tags: ['amenity','description','fixme'], title:'Shelter'},
    {id:"osm_air_compressors", name:'Compressed Air', enabled: false, image:'bike-compressor.png', key:'amenity', val:'compressed_air', showName:false, tags: ['amenity','description','fee','fixme'], title:'Compressed air'},
    {id:"osm_picnic_tables", name:'Picnic Tables', enabled: false, image:'bike-picnic.png', key:'leisure', val:'picnic_table', showName:false, tags: ['amenity','covered','description','fixme'], title:'Picnic table'},
    {id:"osm_bbq", name:'Outdoor Grills', enabled: false, image:'bike-bbq.png', key:'amenity', val:'bbq', showName:false, tags: ['amenity','covered','fuel','description','fixme'], title:'Outdoor grill'},
    {id:"osm_splashpad", name:'Splash Pads', enabled: false, image:'bike-splashpad.png', key:'playground', val:'splash_pad', showName:true, tags: ['name','description','fixme'], title:'Splash pad'},
];

mapboxgl.accessToken = 'pk.eyJ1IjoiYmlrZW90dGF3YSIsImEiOiJjamdqaWxrN3gwZXQ4MnFxbjAwZXRpbG8zIn0.XhAdk2ASwdipubccCWTfoQ';
var map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v10',
  center: [-75.697927,45.417431],
  zoom: 13,
  minZoom: 10,
  maxZoom: 18,
  maxBounds: [[-76.385193,44.963826],[-75.011902,45.614998]],
  attributionControl: false
});

map.addControl(new mapboxgl.NavigationControl(),'bottom-right');
map.addControl(new mapboxgl.AttributionControl({compact: true }), 'bottom-right');
const geocoder = new MapboxGeocoder({
    accessToken: mapboxgl.accessToken,
    bbox: [-76.385193,44.963826,-75.011902,45.614998],
    zoom: 13,
    limit: 10,
    asyncGeocoder: nominatimGeocoder
})
map.addControl(geocoder, 'bottom-left')
map.addControl(new mapboxgl.GeolocateControl({
  positionOptions: {
    enableHighAccuracy: true
  },
    trackUserLocation: true
  }), 'bottom-left');

addStyleSwitcher();

if (!/Mobi/.test(navigator.userAgent)) {
  $('#legend').show();
  $('#legendbtn').hide();
}

//helpers & handlers below

function addStyleSwitcher(){
  var layerList = document.getElementById('menu');
  var inputs = layerList.getElementsByTagName('input');

  for (var i=0; i<inputs.length; i++) {
      inputs[i].onclick = switchLayer;
  }
}

function switchLayer(layer) {
    const layerId = layer.target.id;
    map.setStyle('mapbox://styles/mapbox/' + layerId);
}

function initFromFile() {
  map.addSource('bike_amenities', {
      type: 'geojson',
      data: 'http://localhost:8080/amenities/bike_amenities.geojson',
    });

  layers.forEach(layer => {
    map.loadImage('../img/amenities/'+layer.image, function(error, image) {
      if (error) throw error;
      map.addImage('image_'+layer.id, image);
      map.addLayer({
          "id": layer.id,
          "type": "symbol",
          "source": 'bike_amenities',
          "filter": ['==',layer.key,layer.val],
          "layout": {
              'visibility': layer.enabled?'visible':'none',
              'icon-image': ["match",['get',layer.key],layer.val,'image_'+layer.id,''],
              'icon-size': 0.5,
              "icon-allow-overlap" : true,
              "text-allow-overlap": true,
              'text-field': layer.showName?['get', 'name']:'',
              //'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
              'text-offset': [0, 0.6],
              "text-size": {
                  "stops": [
                      [0, 0],
                      [15, 0],
                      [15.1, 10]
                  ]
              },
              'text-anchor': 'top'
          }
        });
      });

      //document.getElementById(layer.id+'-label').innerHTML = '<span style="display: inline-block;width:20px; height:8px;background-color: '+layer.color+'"></span>&nbsp;&nbsp;'+layer.name;
      document.getElementById(layer.id+'-label').innerHTML = '<img src="../img/amenities/'+layer.image+'" style="width:16px">&nbsp;&nbsp;'+layer.name;
    });
}

function init() {

  map.addSource('bike_amenities', {
      type: 'vector',
      url: 'mapbox://bikeottawa.6e5700mn',
    });
  layers.forEach(layer => {
    map.loadImage(layer.image, function(error, image) {
      if (error) throw error;
      map.addImage('image_'+layer.id, image);
      map.addLayer({
          "id": layer.id,
          "type": "symbol",
          "source": 'bike_amenities',
          "source-layer": 'bike_amenities-0vebvb',
          "layout": {
              'icon-image': ["match",['get',layer.key],layer.val,'image_'+layer.id,''],
              'icon-size': 0.5,
              "icon-allow-overlap" : true,
              "text-allow-overlap": true,
              'text-field': layer.showName?['get', 'name']:'',
              //'text-font': ['Open Sans Semibold', 'Arial Unicode MS Bold'],
              'text-offset': [0, 0.6],
              "text-size": {
                  "stops": [
                      [0, 0],
                      [15, 0],
                      [15.1, 10]
                  ]
              },
              'text-anchor': 'top'
          }
        });
      });

      document.getElementById(layer.id+'-label').innerHTML = '<span style="display: inline-block;width:50px; height:8px;background-color: '+layer.color+'"></span>&nbsp;&nbsp;'+layer.name;
    });
}

map.on('style.load', function () {
  initFromFile()
  //init()
});

const form = document.getElementById("layers");
layers.forEach(l => {
  const input = document.createElement("input");
  input.setAttribute('type', 'checkbox')
  input.setAttribute('id',l.id)
  if(l.enabled){ input.setAttribute('checked','checked')}
  input.onclick = toggleFilter
  form.appendChild(input);
  const label = document.createElement('label')
  label.setAttribute('for',l.id)
  label.setAttribute('class','unround short button icon check quiet col6')
  label.setAttribute('style','text-align:left;')
  label.setAttribute('value', l.name);
  label.setAttribute('id',l.id+'-label')
  form.appendChild(label);
})

function toggleFilter(checkbox) {
  map.setLayoutProperty(checkbox.toElement.id, 'visibility', document.getElementById(checkbox.toElement.id).checked?'visible':'none')
}

map.on('moveend', function(e) {
  window.history.replaceState(null, null, window.location.pathname+'?&lat='+map.getCenter().lat+'&lng='+map.getCenter().lng+'&zoom='+map.getZoom());
});

map.on('click', function(e) {

  const features = map.queryRenderedFeatures(e.point, {
              layers: layers.map(l=>l.id)
          });
  if (!features.length) {
      return;
  }
  const feature = features[0];
  const layer = layers.filter(obj => {return obj.id === feature.layer.id})[0];
  if(layer && layer.tags && layer.title){
    displayOsmElementInfo(feature.properties.id, e.lngLat, layer.tags, 'Bicycle amenities based on mapillary and local knowledge - https://maps.bikeottawa.ca/amenities', layer.title);
  }
  else {
    displayOsmElementInfo(feature.properties.id, e.lngLat,['name','description','fixme'], 'Bicycle amenities based on mapillary and local knowledge - https://maps.bikeottawa.ca/amenities');
  }

  window.history.replaceState(null, null, window.location.pathname+'?&lat='+e.lngLat.lat+'&lng='+e.lngLat.lng+'&zoom='+map.getZoom()+'&id='+feature.properties.id);
});

map.on('mousemove', function(e) {
    const features = map.queryRenderedFeatures(e.point, {
                layers: layers.map(l=>l.id)
            });
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : '';
});

map.on('load', function(e) {
    addUpdatedDate('bikeottawa.6e5700mn')
    document.getElementById("loader").style.visibility = "hidden";
    url = parseUrl(window.location.search.substr(1).split('&'));
    const lat = url['lat']
    const lng = url['lng']
    let z = url['zoom']
    if(lat && lng){
      if(!z){
        z = 18;
      }
      map.flyTo({center: [lng, lat], zoom: z})
      map.once('moveend', function(){
          map.fire("click", {point : map.project([lng, lat]), lngLat: {lng:lng, lat:lat}});
      });
    }
});

</script>
</body>
</html>
